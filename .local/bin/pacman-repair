#!/usr/bin/env bash

function print_qry { printf '\033[034m::>\033[0m %s ' "$1"; }
function print_inf { printf '\033[034m==>\033[0m %s\n' "$1"; }
function print_fin { printf '\033[032m==>\033[0m %s\n' "$1"; }
function print_err { printf '\033[031m==> ERROR:\033[0m %s\n' "$1" >&2; }
function print_wrn { printf '\033[033m==> WARNING:\033[0m %s\n' "$1" >&2; }

sudo -v

if stat '/var/cache/pacman/pkg' > /dev/null 2> /dev/null; then
  print_inf 'Removing leftover install files'
  sudo find '/var/cache/pacman/pkg/' -mindepth 1 -maxdepth 1 -type d -name 'download-*' -exec rm -rf {} +
else
  print_wrn 'Failed to stat /var/cache/pacman/pkg'
fi

declare in

print_inf 'Checking for pacman database lock'
if stat '/var/lib/pacman/db.lck' > /dev/null 2> /dev/null; then
  pidof pacman > /dev/null \
  && print_err 'Pacman is currently in use. Try again later.' \
  && exit 1

  print_qry 'Do you want to remove /var/lib/pacman/db.lck? [y/N]:'
  read in
  case "${in,,}" in
    'y'|'yes') sudo rm /var/lib/pacman/db.lck ;;
    *) print_wrn 'Following operations may fail.' ;;
  esac
fi

function query {
  local flg="$1"
  sudo pacman $flg 2> /dev/null | grep -v ' 0 missing files' | awk -F ': ' '{ print $1 }'
}

print_inf 'Querying for missing files'
declare exp="$(query -Qke)"
declare dep="$(query -Qkd)"

[ -z "$exp" ] && [ -z "$dep" ] \
&& print_fin 'No issues found. :)' \
&& exit 0

declare inst
for m in paru yay pacman; do
  command -v $m > /dev/null \
  && inst="$m" \
  && break
done

[ -z "$inst" ] && print_err 'No package manager found (paru, yay, or pacman)' && exit 1
print_inf "Selected '$inst' as installer for following operations"
[ "$inst" == pacman ] && inst='sudo pacman'

function reinstall {
  local com="$1"
  local pak="$2"
  local flg="$3"
  local dsc="$4"
  local pl
  in=''

  local n="$(echo "$pak" | wc -l)"
  [ "$n" -ne 1 ] && pl='s'

  print_inf "Reinstalling $n $dsc package$pl with missing files"
  [ "$n" -gt 1 ] && print_qry 'Do you want to be prompted for every package? [y/N]:' && read in

  case "${in,,}" in
    'y'|'yes') for p in $pak; do $com -S $flg $p; done ;;
    *) $com -S $flg $pak ;;
  esac
}

while [ -n "$dep" ] || [ -n "$exp" ]; do
  [ -n "$dep" ] && reinstall "$inst" "$dep" '--asdeps' "dependency"
  [ -n "$exp" ] && reinstall "$inst" "$exp" '--asexplicit' "explicitly installed"
  print_inf 'Querying for missing files again'
  dep="$(query -Qkd)"
  exp="$(query -Qke)"
done

print_fin 'No more issues found. :)'
exit 0
